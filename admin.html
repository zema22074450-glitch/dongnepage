<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê´€ë¦¬ì ë„êµ¬ Pro | ë™ë„¤ë§›ì§‘</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root { --primary:#2563eb; --danger:#ef4444; --bg:#f8fafc; --card:#fff; --border:#e2e8f0; --text:#334155; }
body{margin:0;font-family:Pretendard,system-ui,sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
button{border:0;border-radius:8px;padding:10px 16px;font-weight:600;cursor:pointer; transition:.2s}
button:hover{opacity:.85}
.btn-main{background:var(--primary);color:#fff}
.btn-sub{background:#e2e8f0}
.btn-del{background:#fee2e2;color:var(--danger)}
.btn-outline{background:transparent;border:1px solid var(--border)}

.admin-bar{position:sticky;top:0;z-index:10;background:#fff;padding:12px 20px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--border);flex-wrap:wrap}
.search-box{flex:1;min-width:180px;max-width:400px}
.search-box input{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px}

.grid{padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px}
.card{background:#fff;border-radius:16px;border:1px solid var(--border);overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.card img{width:100%;height:160px;object-fit:cover;background:#f1f5f9}
.card-body{padding:14px;display:flex;flex-direction:column;gap:8px}
.card-actions{display:flex;gap:8px}
.card-actions button{flex:1}

.panel{position:fixed;right:0;top:0;width:100%;max-width:420px;height:100%;background:#fff;z-index:20;padding:24px;overflow:auto;box-shadow:-4px 0 15px rgba(0,0,0,.1)}
.panel input,.panel select,.panel textarea{margin-bottom:14px;width:100%;padding:12px;border:1.5px solid var(--border);border-radius:10px}
.preview-box{width:100%;height:180px;background:#f1f5f9;border-radius:12px;margin-bottom:10px;object-fit:cover;border:1px solid var(--border)}
.preview-list{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-bottom:10px}
.preview-list img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#f1f5f9}
.status-msg{font-size:12px;font-weight:700;color:#475569;margin:-8px 0 12px}
.status-msg.ok{color:#059669}
.status-msg.err{color:#dc2626}

#loginBox{max-width:360px;margin:15vh auto;padding:40px;background:#fff;border-radius:20px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,.1)}
.util-btns{padding:0 20px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f172a;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;font-weight:700;opacity:0;pointer-events:none;transition:.2s;z-index:30}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

@media (max-width: 768px){
  .admin-bar{padding:12px;gap:8px}
  .admin-bar b{width:100%}
  .search-box{order:2;max-width:none;width:100%}
  .admin-bar button{flex:1}
  .util-btns{padding:0 12px;justify-content:stretch}
  .util-btns button{flex:1}
  .grid{padding:12px;grid-template-columns:1fr;gap:12px}
  .panel{max-width:none;padding:16px}
}
</style>
</head>
<body>

<div id="loginBox">
  <h2>Admin Access</h2>
  <input id="loginId" placeholder="ì•„ì´ë””">
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <button class="btn-main" style="width:100%" onclick="handleLogin()">ë¡œê·¸ì¸</button>
</div>

<div id="admin" class="hidden">
  <div class="admin-bar">
    <b>ğŸ½ Local Admin</b>
    <div class="search-box">
      <input id="keyword" placeholder="ê°€ê²Œ ì´ë¦„ ê²€ìƒ‰" oninput="render()">
    </div>
    <button class="btn-main" onclick="openEdit()">+ ì¶”ê°€</button>
    <button class="btn-sub" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div class="util-btns" style="margin-top:16px">
    <button class="btn-outline" onclick="exportData()">ğŸ’¾ ë°±ì—…</button>
    <button class="btn-outline" onclick="importFile.click()">ğŸ“‚ ë³µêµ¬</button>
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
  </div>

  <div class="grid" id="list"></div>
</div>

<div id="editPanel" class="panel hidden">
  <h3 id="panelHeader"></h3>
  <img id="imgPrev" class="preview-box" alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
  <div id="imgList" class="preview-list"></div>
  <div id="imgStatus" class="status-msg">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì—ì„œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
  <input id="fid" readonly>
  <input id="fname" placeholder="ê°€ê²Œëª… *">
  <div style="display:flex;gap:8px;align-items:flex-start">
    <select id="fcat" style="flex:1;margin-bottom:0"></select>
    <button class="btn-outline" type="button" onclick="toggleCategoryEditor()">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
  </div>
  <div id="catEditor" class="hidden" style="display:flex;gap:8px;margin:10px 0 14px">
    <input id="newCat" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ëª…" style="margin:0;flex:1">
    <button class="btn-main" type="button" onclick="addCategory()">ì¶”ê°€</button>
  </div>

  <input type="file" id="fileInput" accept="image/*" multiple onchange="handleImgUpload(event)">
  <textarea id="fimgs" rows="3" placeholder="ì´ë¯¸ì§€ URL ì—¬ëŸ¬ ê°œ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„, ìµœëŒ€ 4ì¥)" oninput="updatePreview()"></textarea>
  <input id="fimg" placeholder="ëŒ€í‘œ ì´ë¯¸ì§€ URL (ì²« ì´ë¯¸ì§€ë¡œ ìë™ ì„¤ì •)" readonly>

  <textarea id="fdesc" rows="3" placeholder="ì†Œê°œ"></textarea>

  <div style="display:flex;gap:8px;align-items:center">
    <label><input type="checkbox" id="fad"> ê´‘ê³ </label>
    <input type="date" id="funtil" style="flex:1">
  </div>

  <button class="btn-main" style="width:100%" onclick="handleSave()">ì €ì¥</button>
  <button class="btn-sub" style="width:100%" onclick="closeAll()">ì·¨ì†Œ</button>
  <button class="btn-del" id="delBtn" style="width:100%" onclick="handleDelete()">ì‚­ì œ</button>
</div>

<div id="toast" class="toast">Saved successfully</div>

<script src="shared/category-store.js"></script>
<script>
const ADMIN_ID="admin", ADMIN_PW="1234";
const DB={AUTH:"ADMIN_LOGGED_IN",DATA:"PLACES_DATA",CAT:"CATEGORY_LIST"};
const DEFAULT_CATS=CategoryStore.DEFAULT_CATEGORIES;
const LOGIN_LIMIT=1000*60*60*24;
const MAX_IMAGE_COUNT=4;

let toastTimer=null;
function showToast(msg){
  toast.innerText=msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove("show"),1600);
}

function handleLogin(){
  if(loginId.value===ADMIN_ID&&loginPw.value===ADMIN_PW){
    localStorage.setItem(DB.AUTH,Date.now());init();
  } else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
}
function handleLogout(){
  localStorage.removeItem(DB.AUTH);location.reload();
}
function init(){
  const t=localStorage.getItem(DB.AUTH);
  if(!t||Date.now()-t>LOGIN_LIMIT){
    alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    localStorage.removeItem(DB.AUTH);
    return;
  }
  loginBox.classList.add("hidden");
  admin.classList.remove("hidden");
  CategoryStore.loadCategories();
  render();
}
if(localStorage.getItem(DB.AUTH)) init();

const getDB=()=>JSON.parse(localStorage.getItem(DB.DATA)||"[]");
const getCategories=()=>CategoryStore.loadCategories();
const setCategories=(cats)=>CategoryStore.saveCategories(cats);

function normalizeCat(value){
  return String(value||"").trim();
}

function categoryLabel(cat){
  return CategoryStore.displayCategory(cat);
}

function parseImageList(value){
  if(!value) return [];
  return Array.from(new Set(
    String(value)
       .split(/\n/)
      .map(v=>v.trim())
      .filter(Boolean)
  )).slice(0,MAX_IMAGE_COUNT);
}

function encodeImageList(list){
  return list.join("\n");
}

function getItemImages(item){
  const imgsFromArray = Array.isArray(item?.imgs) ? item.imgs : [];
  const merged = [...imgsFromArray];
  if(item?.img) merged.unshift(item.img);
  return Array.from(new Set(merged.map(v=>String(v||"").trim()).filter(Boolean))).slice(0,MAX_IMAGE_COUNT);
}

function renderCategoryOptions(selected=""){
  const cats=getCategories();
  fcat.innerHTML=cats.map(c=>`<option value="${c}">${categoryLabel(c)}</option>`).join("");
  if(selected&&cats.includes(selected)) fcat.value=selected;
}

function toggleCategoryEditor(){
  catEditor.classList.toggle("hidden");
  if(!catEditor.classList.contains("hidden")) newCat.focus();
}

function addCategory(){
  const cat=normalizeCat(newCat.value);
  if(!cat) return alert("ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const cats=getCategories();
  const normalized=CategoryStore.normalizeCategory(cat);
  if(cats.includes(normalized)) return alert("ì´ë¯¸ ìˆëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.");
  cats.push(normalized);
  setCategories(cats);
  renderCategoryOptions(normalized);
  newCat.value="";
  showToast("ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤");
}

function render(){
  const word=(keyword.value||"").toLowerCase();
  list.innerHTML="";
  getDB().filter(x=>x.name.toLowerCase().includes(word)).forEach(item=>{
    list.innerHTML+=`
    <div class="card">
      <img src="${getItemImages(item)[0]||'https://via.placeholder.com/300x160?text=No+Image'}">
      <div class="card-body">
        <b>${item.name}</b>
        <div class="card-actions">
          <button class="btn-sub" onclick="openEditById('${item.id}')">ìˆ˜ì •</button>
          <button class="btn-del" onclick="quickDelete('${item.id}')">ì‚­ì œ</button>
        </div>
      </div>
    </div>`;
  });
}

function handleImgUpload(e){
  const files=Array.from(e.target.files||[]);
  if(!files.length) return;
  const existing=parseImageList(fimgs.value);
  const room=Math.max(0,MAX_IMAGE_COUNT-existing.length);
  if(!room){
    imgStatus.className="status-msg err";
    imgStatus.innerText=`ì´ë¯¸ì§€ëŠ” ìµœëŒ€ ${MAX_IMAGE_COUNT}ì¥ê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
    e.target.value="";
    return;
  }

  const valid=files.slice(0,room);
  for(const file of valid){
    if(!file.type.startsWith("image/")){
      imgStatus.className="status-msg err";
      imgStatus.innerText="ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      e.target.value="";
      return;
    }
    if(file.size>3*1024*1024){
      imgStatus.className="status-msg err";
      imgStatus.innerText="ì´ë¯¸ì§€ëŠ” 3MB ì´í•˜ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.";
      e.target.value="";
      return;
    }
  }

  Promise.all(valid.map(file=>new Promise(resolve=>{
    const r=new FileReader();
    r.onload=ev=>resolve({file,data:ev.target.result});
    r.readAsDataURL(file);
  }))).then(results=>{
    const merged=[...existing,...results.map(x=>x.data)];
    const normalized=Array.from(new Set(merged)).slice(0,MAX_IMAGE_COUNT);
    fimgs.value=encodeImageList(normalized);
    fimg.value=normalized[0]||"";
    imgStatus.className="status-msg ok";
    imgStatus.innerText=`ì´ë¯¸ì§€ ${results.length}ì¥ ì¶”ê°€ ì™„ë£Œ (ì´ ${normalized.length}/${MAX_IMAGE_COUNT}ì¥)`;
    updatePreview();
  });
  e.target.value="";
}
function updatePreview(){
  const images=parseImageList(fimgs.value);
  fimg.value=images[0]||"";
  imgPrev.src=images[0]||"https://via.placeholder.com/400x200?text=No+Image";
  imgList.innerHTML=images.map(src=>`<img src="${src}" alt="ë¯¸ë¦¬ë³´ê¸°">`).join("");

  if(!images.length){
    imgStatus.className="status-msg";
    imgStatus.innerText="ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì—ì„œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
  }else if(!imgStatus.classList.contains("err")){
    imgStatus.className="status-msg ok";
    imgStatus.innerText=`ì´ë¯¸ì§€ ${images.length}ì¥ ì¤€ë¹„ ì™„ë£Œ`;
  }
}

function openEditById(id){
  openEdit(getDB().find(x=>x.id===id));
}
function openEdit(item=null){
  renderCategoryOptions(item?.cat||DEFAULT_CATS[0]);
  editPanel.classList.remove("hidden");
  delBtn.classList.toggle("hidden",!item);
  panelHeader.innerText=item?"ìˆ˜ì •":"ì¶”ê°€";
  fid.value=item?.id||("R"+Date.now()+Math.floor(Math.random()*1000));
  fname.value=item?.name||"";
  const itemCat=CategoryStore.normalizeCategory(item?.cat);
  if(itemCat && !getCategories().includes(itemCat)){
    const cats=getCategories();
    cats.push(itemCat);
    setCategories(cats);
    renderCategoryOptions(itemCat);
  }
  fcat.value=itemCat||DEFAULT_CATS[0];
  const images=getItemImages(item);
  fimgs.value=encodeImageList(images);
  fimg.value=images[0]||"";
  fdesc.value=item?.desc||"";
  fad.checked=item?.ad||item?.sponsor||false;
  funtil.value=item?.until||item?.sponsorUntil||"";
  updatePreview();
}
function closeAll(){
  editPanel.classList.add("hidden");
  fileInput.value="";
  catEditor.classList.add("hidden");
  newCat.value="";
}

function handleSave(){
  if(!fname.value.trim()) return alert("ê°€ê²Œëª… í•„ìˆ˜");
  if(fad.checked&&!funtil.value) return alert("ê´‘ê³  ì¢…ë£Œì¼ í•„ìˆ˜");
  const data=getDB();
  const item={
    id:fid.value,
    name:fname.value.trim(),
    cat:fcat.value,
    img:parseImageList(fimgs.value)[0]||"",
    imgs:parseImageList(fimgs.value),
    desc:fdesc.value.trim(),
    sponsor:fad.checked,
    sponsorUntil:funtil.value,
    ad:fad.checked,
    until:funtil.value
  };
  const i=data.findIndex(x=>x.id===item.id);
  i>-1?data[i]=item:data.push(item);
  localStorage.setItem(DB.DATA,JSON.stringify(data));
  closeAll();render();
  showToast("Saved successfully");
}
function quickDelete(id){
  if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
  localStorage.setItem(DB.DATA,JSON.stringify(getDB().filter(x=>x.id!==id)));
  render();
  showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
}
function handleDelete(){
  quickDelete(fid.value);
  closeAll();
}

function exportData(){
  const blob=new Blob([localStorage.getItem(DB.DATA)||"[]"],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
function importData(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const json=JSON.parse(ev.target.result);
      if(!Array.isArray(json)) throw 1;
      if(confirm("ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.")){
        localStorage.setItem(DB.DATA,JSON.stringify(json));
        render();alert("ë³µêµ¬ ì™„ë£Œ");
      }
    }catch{alert("ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.");}
  };
  r.readAsText(f);
}
</script>
</body>
</html>
